{"version":3,"file":"acfwf-edit-order.js","mappings":"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","sources":["webpack://advanced-coupons-free/./packages/acfwf-edit-order/index.ts"],"sourcesContent":["\"use strict\";\r\njQuery(document).ready(function ($) {\r\n    var Funcs = {\r\n        /**\r\n         * Append store credit refund button when \"refund\" button is clicked for the first time.\r\n         */\r\n        appendStoreCreditRefundButton: function () {\r\n            if ($('#acfw-refund-as-store-credits').length) {\r\n                return;\r\n            }\r\n            $('#post-body .refund-actions').prepend('<button type=\"button\" id=\"acfw-refund-as-store-credits\" class=\"button button-primary\">' +\r\n                acfwEditOrder.button_text +\r\n                '</button>');\r\n            $('#post-body button.refund-items').on('click', Funcs.appendStoreCreditRefundButton);\r\n        },\r\n        /**\r\n         * Adjust button text when refund amount is changed.\r\n         */\r\n        refundAmountChanged: function () {\r\n            var total = accounting.unformat($(this).val(), woocommerce_admin.mon_decimal_point);\r\n            $('button#acfw-refund-as-store-credits .amount').text(accounting.formatMoney(total, {\r\n                symbol: woocommerce_admin_meta_boxes.currency_format_symbol,\r\n                decimal: woocommerce_admin_meta_boxes.currency_format_decimal_sep,\r\n                thousand: woocommerce_admin_meta_boxes.currency_format_thousand_sep,\r\n                precision: woocommerce_admin_meta_boxes.currency_format_num_decimals,\r\n                format: woocommerce_admin_meta_boxes.currency_format,\r\n            }));\r\n        },\r\n        /**\r\n         * Process manual refund via store credits.\r\n         */\r\n        doRefund: function () {\r\n            Funcs.blockMetabox();\r\n            if (window.confirm(woocommerce_admin_meta_boxes.i18n_do_refund)) {\r\n                var refund_amount = $('input#refund_amount').val();\r\n                var refund_reason = $('input#refund_reason').val();\r\n                var refunded_amount = $('input#refunded_amount').val();\r\n                // Get line item refunds\r\n                var line_item_qtys = {};\r\n                var line_item_totals = {};\r\n                var line_item_tax_totals = {};\r\n                $('.refund input.refund_order_item_qty').each(function (index, item) {\r\n                    if ($(item).closest('tr').data('order_item_id')) {\r\n                        if ($(item).val()) {\r\n                            line_item_qtys[$(item).closest('tr').data('order_item_id')] = $(item).val();\r\n                        }\r\n                    }\r\n                });\r\n                $('.refund input.refund_line_total').each(function (index, item) {\r\n                    if ($(item).closest('tr').data('order_item_id')) {\r\n                        line_item_totals[$(item).closest('tr').data('order_item_id')] = accounting.unformat($(item).val(), woocommerce_admin.mon_decimal_point);\r\n                    }\r\n                });\r\n                $('.refund input.refund_line_tax').each(function (index, item) {\r\n                    if ($(item).closest('tr').data('order_item_id')) {\r\n                        var tax_id = $(item).data('tax_id');\r\n                        if (!line_item_tax_totals[$(item).closest('tr').data('order_item_id')]) {\r\n                            line_item_tax_totals[$(item).closest('tr').data('order_item_id')] = {};\r\n                        }\r\n                        line_item_tax_totals[$(item).closest('tr').data('order_item_id')][tax_id] = accounting.unformat($(item).val(), woocommerce_admin.mon_decimal_point);\r\n                    }\r\n                });\r\n                var data = {\r\n                    action: 'woocommerce_refund_line_items',\r\n                    order_id: woocommerce_admin_meta_boxes.post_id,\r\n                    refund_amount: refund_amount,\r\n                    refunded_amount: refunded_amount,\r\n                    refund_reason: refund_reason,\r\n                    line_item_qtys: JSON.stringify(line_item_qtys, null, ''),\r\n                    line_item_totals: JSON.stringify(line_item_totals, null, ''),\r\n                    line_item_tax_totals: JSON.stringify(line_item_tax_totals, null, ''),\r\n                    api_refund: $(this).is('.do-api-refund'),\r\n                    restock_refunded_items: $('#restock_refunded_items:checked').length ? 'true' : 'false',\r\n                    security: woocommerce_admin_meta_boxes.order_item_nonce,\r\n                    acfw_store_credits: true,\r\n                };\r\n                $.ajax({\r\n                    url: woocommerce_admin_meta_boxes.ajax_url,\r\n                    data: data,\r\n                    type: 'POST',\r\n                    success: function (response) {\r\n                        if (true === response.success) {\r\n                            // Redirect to same page for show the refunded status\r\n                            window.location.reload();\r\n                        }\r\n                        else {\r\n                            window.alert(response.data.error);\r\n                            $('#woocommerce-order-items').trigger('wc_order_items_reload');\r\n                            Funcs.unblockMetabox();\r\n                        }\r\n                    },\r\n                    complete: function () {\r\n                        window.wcTracks.recordEvent('order_edit_refunded', {\r\n                            order_id: data.order_id,\r\n                            status: $('#order_status').val(),\r\n                            api_refund: data.api_refund,\r\n                            has_reason: !!data.refund_reason,\r\n                            restock: 'true' === data.restock_refunded_items,\r\n                        });\r\n                    },\r\n                });\r\n            }\r\n            else {\r\n                Funcs.unblockMetabox();\r\n            }\r\n        },\r\n        /**\r\n         * Block order metabox.\r\n         */\r\n        blockMetabox: function () {\r\n            // @ts-ignore\r\n            $('#woocommerce-order-items').block({\r\n                message: null,\r\n                overlayCSS: {\r\n                    background: '#fff',\r\n                    opacity: 0.6,\r\n                },\r\n            });\r\n        },\r\n        /**\r\n         * Unblock order metabox.\r\n         */\r\n        unblockMetabox: function () {\r\n            // @ts-ignore\r\n            $('#woocommerce-order-items').unblock();\r\n        },\r\n        /**\r\n         * Move the payment summary rows below the order totals when the page is loaded.\r\n         */\r\n        movePaymentSummaryBelowOrderTotals: function () {\r\n            // skip if order was not paid with store credits\r\n            if (!$('.wc-order-totals-items .wc-order-totals tr.acfw-payment-row').length) {\r\n                return;\r\n            }\r\n            $('.wc-order-totals-items .wc-order-totals tr.acfw-payment-row').appendTo('.wc-order-totals-items .wc-order-totals:first-child tbody');\r\n            $('.wc-order-totals-items .wc-order-totals tr.acfw-payment-row').removeClass('acfw-payment-row');\r\n            if ($('.wc-order-totals-items table.wc-order-totals').length > 2) {\r\n                $($('.wc-order-totals-items table.wc-order-totals')[1]).remove();\r\n            }\r\n        },\r\n        applyStoreCreditsToOrder: function () {\r\n            var $button = $(this);\r\n            var value = window.prompt(acfwEditOrder.apply_store_credits_prompt, acfwEditOrder.order_store_credits_amount);\r\n            if (null === value) {\r\n                return;\r\n            }\r\n            Funcs.blockMetabox();\r\n            $.ajax({\r\n                url: woocommerce_admin_meta_boxes.ajax_url,\r\n                data: {\r\n                    action: 'acfwf_apply_store_credits_to_order',\r\n                    order_id: woocommerce_admin_meta_boxes.post_id,\r\n                    amount: value,\r\n                    security: woocommerce_admin_meta_boxes.order_item_nonce,\r\n                },\r\n                type: 'POST',\r\n                success: function (response) {\r\n                    if (true === response.success) {\r\n                        // reload window\r\n                        window.location.reload();\r\n                    }\r\n                    else {\r\n                        window.alert(response.data.error);\r\n                    }\r\n                    Funcs.unblockMetabox();\r\n                },\r\n            });\r\n        },\r\n        /**\r\n         * Disallow deleting the store credit coupon in the edit order page.\r\n         */\r\n        disallowDeleteStoreCreditCoupon: function () {\r\n            $(\"ul.wc_coupon_list li span span:contains('\" + acfwEditOrder.store_credit_coupon_code + \"')\")\r\n                .closest('.code')\r\n                .removeClass('editable')\r\n                .find('a.remove-coupon')\r\n                .remove();\r\n        },\r\n        /**\r\n         * Initialize script and register events.\r\n         */\r\n        init: function () {\r\n            $('#woocommerce-order-items').on('click', 'button.refund-items', Funcs.appendStoreCreditRefundButton);\r\n            $('#woocommerce-order-items').on('change keyup', '.wc-order-refund-items #refund_amount', Funcs.refundAmountChanged);\r\n            $('body').on('click', 'button#acfw-refund-as-store-credits', Funcs.doRefund);\r\n            $('body').on('order-totals-recalculate-complete', Funcs.movePaymentSummaryBelowOrderTotals);\r\n            $('body').on('click', 'button.acfw-apply-store-credits', Funcs.applyStoreCreditsToOrder);\r\n        },\r\n    };\r\n    Funcs.movePaymentSummaryBelowOrderTotals();\r\n    Funcs.disallowDeleteStoreCreditCoupon();\r\n    Funcs.init();\r\n});\r\n"],"names":["jQuery","document","ready","$","Funcs","appendStoreCreditRefundButton","length","prepend","acfwEditOrder","button_text","on","refundAmountChanged","total","accounting","unformat","this","val","woocommerce_admin","mon_decimal_point","text","formatMoney","symbol","woocommerce_admin_meta_boxes","currency_format_symbol","decimal","currency_format_decimal_sep","thousand","currency_format_thousand_sep","precision","currency_format_num_decimals","format","currency_format","doRefund","blockMetabox","window","confirm","i18n_do_refund","refund_amount","refund_reason","refunded_amount","line_item_qtys","line_item_totals","line_item_tax_totals","each","index","item","closest","data","tax_id","action","order_id","post_id","JSON","stringify","api_refund","is","restock_refunded_items","security","order_item_nonce","acfw_store_credits","ajax","url","ajax_url","type","success","response","location","reload","alert","error","trigger","unblockMetabox","complete","wcTracks","recordEvent","status","has_reason","restock","block","message","overlayCSS","background","opacity","unblock","movePaymentSummaryBelowOrderTotals","appendTo","removeClass","remove","applyStoreCreditsToOrder","value","prompt","apply_store_credits_prompt","order_store_credits_amount","amount","disallowDeleteStoreCreditCoupon","store_credit_coupon_code","find","init"],"sourceRoot":""}